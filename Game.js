"use strict";function controlsListFromControlsBinaryId(t){let e=[];const n={"action-u":1,"action-l":2,"action-r":4,"color-r":8,"color-g":16,"color-b":32,"action-p-r":64,"action-p-g":128,"action-p-b":256,"action-f-1":512,"action-f-2":1024};for(const i in n)t&n[i]&&e.push(i);return e}function twoDimArrayFromColumnsAndString(t,e){let n=[];const i=e.split(" "),s=i.length/t;for(let e=0;e<s;e++)n.push(i.slice(t*e,t*(e+1)));return n=n.reverse(),n}function elementCoordinatesFromColumnsAndElementsString(t,e,n){const i={x:void 0,y:void 0},s=n.split(" ");for(let n=0;n<s.length;n++){if(s[n]===t){i.x=n%e;const t=s.length/e;i.y=t-1-Math.floor(n/e);break}}return i}function convertedAngle(t){return(t-.5+2)%2}function deepCopy(t){let e,n,i;if("object"!=typeof t||null===t)return t;for(i in e=Array.isArray(t)?[]:{},t)n=t[i],e[i]=deepCopy(n);return e}function getMinSolutionFunctionsLengths(t){const e=[];for(let n=1;;n++){const i="f"+n.toString()+"MinSol";if(!(i in t))break;{const n=t[i];0===n.length?e.push(0):e.push(n.split(" ").length)}}return e}function getConvertedLevelDescription(t){const e=deepCopy(t);return{name:e.name,availableControls:controlsListFromControlsBinaryId(e.controlsBinaryId),colors:twoDimArrayFromColumnsAndString(e.columns,e.path),angle:convertedAngle(e.angle),elements:twoDimArrayFromColumnsAndString(e.columns,e.elements),arrowCoordinates:elementCoordinatesFromColumnsAndElementsString("a",e.columns,e.elements),finishCoordinates:elementCoordinatesFromColumnsAndElementsString("f",e.columns,e.elements)}}function emptyFunctionsListFromLevelDescription(t){let e=[];for(let n=1;;n++){const i="f"+n.toString()+"Len";if(!(i in t))break;{const s=t[i];if(0===s)break;let o=[];for(let t=0;t<s;t++)o.push({color:"n",functionIndex:n-1,commandIndex:t});e.push(o)}}return e}class Game extends React.Component{constructor(t){super(t);const e=t.level,n=t.backToMenuFunction,i=t.nextLevelFunction,s=t.restartLevelFunction,o=t.reportAchivmentsFunction,r=emptyFunctionsListFromLevelDescription(e);this.state={backToMenuFunction:n,restartLevelFunction:s,reportAchivmentsFunction:o,nextLevelFunction:i,initialLevelDescription:getConvertedLevelDescription(e),stack:[],stackPointerPosition:void 0,functionsList:r,speed:0,testing:!1,mapWidth:void 0,mapHeight:void 0,draggingControllerType:void 0,draggingControllerPosition:void 0,timersIds:[],finishReached:!1,minSolutionFunctionsLengths:e.minSolutionFunctionsLengths},this.state.levelDescription=deepCopy(this.state.initialLevelDescription),this.onMouseDownOnAvailableControl=this.onMouseDownOnAvailableControl.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.loadCurrentAlgorithmToStack=this.loadCurrentAlgorithmToStack.bind(this),this.speedRangeOnInput=this.speedRangeOnInput.bind(this),this.onMouseDownOnFunctionCell=this.onMouseDownOnFunctionCell.bind(this),this.getAchivmentsBinary=this.getAchivmentsBinary.bind(this),this.refreshMapSize=this.refreshMapSize.bind(this),this.onContextMenu=this.onContextMenu.bind(this)}resetLevel(){this.setState((t=>(t.timersIds.forEach(clearTimeout),{levelDescription:deepCopy(t.initialLevelDescription),stack:[],stackPointerPosition:void 0,timersIds:[]})))}resetFunctions(){this.setState((t=>({functionsList:deepCopy(t.emptyFunctionsList)})))}isCellPassable(t,e){const n=this.state.levelDescription.colors[e];if(void 0===n)return!1;const i=n[t];return void 0!==i&&"n"!==i}canMove(t){if("l"===t||"r"===t)return!0;if("u"===t){const t=this.state.levelDescription.arrowCoordinates.x,e=this.state.levelDescription.arrowCoordinates.y,n=this.state.levelDescription.angle;return 0===n&&this.isCellPassable(t+1,e)||.5===n&&this.isCellPassable(t,e-1)||1===n&&this.isCellPassable(t-1,e)||1.5===n&&this.isCellPassable(t,e+1)}return null}turn(t){const e=this.state.levelDescription.angle;let n;"l"===t?n=1.5===e?0:e+.5:"r"===t&&(n=0===e?1.5:e-.5);let i=this.state;return i.levelDescription.angle=n,i}move(t){let e=this.state;if("l"===t||"r"===t)e=this.turn(t);else if("u"===t){const t={x:this.state.levelDescription.arrowCoordinates.x,y:this.state.levelDescription.arrowCoordinates.y};0===this.state.levelDescription.angle?t.x=this.state.levelDescription.arrowCoordinates.x+1:.5===this.state.levelDescription.angle?t.y=this.state.levelDescription.arrowCoordinates.y-1:1===this.state.levelDescription.angle?t.x=this.state.levelDescription.arrowCoordinates.x-1:1.5===this.state.levelDescription.angle&&(t.y=this.state.levelDescription.arrowCoordinates.y+1);const n=this.state.levelDescription.arrowCoordinates;e.levelDescription.elements[n.y][n.x]="n",e.levelDescription.elements[t.y][t.x]="a",e.levelDescription.arrowCoordinates=t}return e}tryMove(t){return this.canMove(t)?this.move(t):(this.resetLevel(),!1)}loadCurrentAlgorithmToStack(){this.setState((t=>({stackPointerPosition:0,stack:t.functionsList[0]})))}commandCondition(t){const e=this.state.levelDescription.arrowCoordinates.x,n=this.state.levelDescription.arrowCoordinates.y,i=this.state.levelDescription.colors[n][e];return t.color===i||"n"===t.color}replaceElement(t,e,n){let i=[];return i=i.concat(t.slice(0,n)),i=i.concat(e),i=i.concat(t.slice(n+1)),i}finishReached(){if(!0===this.state.finishReached)return!0;const t=this.state.levelDescription.arrowCoordinates.x,e=this.state.levelDescription.arrowCoordinates.y,n=this.state.levelDescription.finishCoordinates,i=t===n.x&&e===n.y;return!0===i&&this.setState({finishReached:!0}),i}paintArrowCell(t){let e=this.state;const n=this.state.levelDescription.arrowCoordinates.x,i=this.state.levelDescription.arrowCoordinates.y;return e.levelDescription.colors[i][n]=t,e}clearTimers(){this.setState((t=>(t.timersIds.forEach(clearTimeout),{timersIds:[]})))}componentDidUpdate(t,e){const n=this.state.stack;if(0===n.length)return;const i=Number.parseFloat(this.state.speed);if(!(i>0))return;const s=this.state.stackPointerPosition;if(s===n.length)return void this.resetLevel();if(this.finishReached())return void(this.state.timersIds.length>0&&this.clearTimers());if(this.state.timersIds.length>0)return;const o=n[s],r=this.state.functionsList;let l=n,a=s+1,c=this.state,h=this.state.testing;if(void 0!==o.action&&!0===this.commandCondition(o))if("f"===o.action)l=this.replaceElement(n,r[o.fNumber-1],s),a=s;else if("p"===o.action[0])c=this.paintArrowCell(o.paintColor);else if(c=this.tryMove(o.action),!1===c)return;const u=setTimeout((()=>{0===this.state.speed?this.clearTimers():this.setState((t=>{c.stack=l,c.stackPointerPosition=a,c.testing=h;const e=c.timersIds.indexOf(u);return e>-1&&c.timersIds.splice(e,1),c.speed=t.speed,c}))}),1e3/((i+1)*(i+1)));this.setState((t=>{if(-1===t.timersIds.indexOf(u))return{timersIds:t.timersIds.concat([u])}}))}onMouseDownOnAvailableControl(t,e){if(this.state.speed>0)return;const n=void 0!==t.clientX?t.clientX:t.touches[0].clientX,i=void 0!==t.clientY?t.clientY:t.touches[0].clientY;this.setState((t=>({draggingControllerPosition:{x:n,y:i},draggingControllerType:e})))}onMouseDownOnFunctionCell(t){const e=t.target,n=e.getAttribute("rowindex"),i=e.getAttribute("cellIndex");if(2===t.button)return void this.setState((t=>{const e=t.functionsList;return e[n][i].action=void 0,e[n][i].color="n",e}));const s=this.state.functionsList[n][i],o=void 0!==t.clientX?t.clientX:t.touches[0].clientX,r=void 0!==t.clientY?t.clientY:t.touches[0].clientY;if(void 0!==s.action){const t=s.action;let e="action-"+t;"f"===t?e+="-"+s.fNumber.toString():"p"===t&&(e+="-"+s.paintColor),this.setState((t=>{const s=t.functionsList;return s[n][i].action=void 0,{functionsList:s,draggingControllerPosition:{x:o,y:r},draggingControllerType:e}}))}else if("n"!==s.color){const t="color-"+s.color;this.setState((e=>{const s=e.functionsList;return s[n][i].color="n",{functionsList:s,draggingControllerPosition:{x:o,y:r},draggingControllerType:t}}))}}onMouseMove(t){if(void 0===this.state.draggingControllerType)return;const e=void 0!==t.clientX?t.clientX:t.touches[0].clientX,n=void 0!==t.clientY?t.clientY:t.touches[0].clientY;this.setState((t=>({draggingControllerPosition:{x:e,y:n}})))}onMouseUp(t){if(this.setState({speed:0,stack:[],stackPointerPosition:void 0}),void 0!==this.state.stackPointerPosition&&this.resetLevel(),void 0===this.state.draggingControllerType)return;const e=void 0!==t.clientX?t.clientX:t.changedTouches[0].clientX,n=void 0!==t.clientY?t.clientY:t.changedTouches[0].clientY,i=document.getElementById("draggingController");i.hidden=!0;const s=document.elementFromPoint(e,n);if(i.hidden=!1,s.classList.contains("functionCell")){const t=s.getAttribute("rowindex"),e=s.getAttribute("cellindex"),n=this.state.draggingControllerType.split("-"),i=n[0],o=n[1],r={};r[i]=o,"action"===i&&("f"===o&&(r.fNumber=n[2]),"p"===o&&(r.paintColor=n[2])),this.setState((n=>{const i=n.functionsList[t][e],s=Object.assign(i,r);return n.functionsList[t][e]=s,{functionsList:n.functionsList}}))}this.setState((t=>({draggingControllerType:void 0})))}speedRangeOnInput(t){0===this.state.stack.length&&(this.resetLevel(),this.loadCurrentAlgorithmToStack()),this.setState({speed:t.target.value})}refreshMapSize(){const t=this.state.levelDescription.colors,e=80*window.innerWidth/100,n=50*window.innerHeight/100,i=t.length,s=t[0].length,o=Math.min(e/s,n/i),r=o*s+"px",l=o*i+"px";this.setState({mapWidth:r,mapHeight:l})}onContextMenu(t){t.preventDefault()}componentDidMount(){window.addEventListener("resize",this.refreshMapSize),this.refreshMapSize(),window.addEventListener("contextmenu",this.onContextMenu)}componentWillUnmount(){window.removeEventListener("resize",this.refreshMapSize),window.removeEventListener("contextmenu",this.onContextMenu)}isAllStarsGathered(){const t=this.state.levelDescription.elements;for(const e of t)for(const t of e)if("s"===t)return!1;return!0}functionNotEmptyCellsNumber(t){let e=0;for(const n of t)void 0!==n.action&&(e+=1);return e}isCurrentAlgorithmMinimal(){const t=this.state.minSolutionFunctionsLengths,e=this.state.functionsList;for(let n=0;n<t.length;n++)if(void 0!==e[n]&&t[n]<this.functionNotEmptyCellsNumber(e[n]))return!1;return!0}getAchivments(){return{levelFinished:!0,minSolutionFound:this.isCurrentAlgorithmMinimal(),allStarsGathered:this.isAllStarsGathered()}}getAchivmentsBinary(){const t=this.getAchivments();return[t.levelFinished,t.minSolutionFound,t.allStarsGathered]}getAchivmentsHtml(){const t=this.getAchivments();return React.createElement("div",{className:"achivments"},Object.entries(t).map((t=>{const e=t[0],n="achivment "+e;return t[1]?React.createElement("div",{key:e,className:n}):null})))}render(){const t=this.state.levelDescription.colors,e=this.state.levelDescription.elements,n=this.state.levelDescription.angle,i=this.state.levelDescription.availableControls,s=this.state.functionsList,o=this.state.draggingControllerType,r=this.state.draggingControllerPosition,l=this.speedRangeOnInput,a=this.state.speed,c=this.state.minSolutionFunctionsLengths,h=!0===this.state.finishReached,u=this.onMouseDownOnFunctionCell,d=h?null:this.onMouseUp,m=this.onMouseMove,p=this.onMouseDownOnAvailableControl,v=this.state.backToMenuFunction,g=h?this.getAchivmentsBinary():null,f=h?g.filter((t=>!0===t)).length:null,C=this.state.stack[this.state.stackPointerPosition],y=void 0===C?void 0:C.functionIndex,D=void 0===C?void 0:C.commandIndex,M=this.state.mapWidth,L=this.state.mapHeight;return React.createElement("div",{className:"Game",onKeyDown:this.handleKeyPress,onMouseUp:d,onTouchEnd:d,onMouseMove:m,onTouchMove:m,tabIndex:-1},React.createElement("button",{className:"backToMenuButton",onClick:v}),h?React.createElement(ModalWindow,{className:"finishMenu",closeFunction:t=>null},React.createElement("div",{className:"verdict"},["CONGRATULATIONS","AWESOME","AMAZING"][f-1]),this.getAchivmentsHtml(),React.createElement("div",{className:"buttons"},React.createElement("button",{className:"button restartButton",onClick:t=>this.state.restartLevelFunction(g)},"Restart"),React.createElement("button",{className:"button nextButton",onClick:t=>this.state.nextLevelFunction(g)},"Next"))):null,React.createElement("div",{className:"Map",style:{width:M,height:L}},React.createElement(ColorLayer,{colors:t,mapWidth:M,mapHeight:L}),React.createElement(ElementsLayer,{elements:e,angle:n,mapWidth:M,mapHeight:L})),React.createElement("div",{className:"ControlsPanel"},React.createElement(AvailableControls,{controlsList:i,onMouseDown:p,onTouchStart:p}),React.createElement(Functions,{functionsList:s,pointerFunctionIndex:y,pointerCommandIndex:D,onMouseDownOnFunctionCell:u,onTouchStart:u,minSolutionFunctionsLengths:c}),void 0===o?null:React.createElement(DraggingController,{type:o,position:r}),React.createElement("input",{className:"speedRange",type:"range",min:"0",max:"7",step:"0.1",value:a,onChange:l})))}}